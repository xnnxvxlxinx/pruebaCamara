<!DOCTYPE HTML>
<html>
<head>
    <title>Mi Ubicaci&oacute;n</title>
     <meta
  name="viewport"
  content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
   
	<link rel="stylesheet" type="text/css" href="../archivosbase/CSS/cabeza.css">
 <link rel="stylesheet" type="text/css" href="../archivosbase/CSS/estilosinlabel.css">
	<link rel="stylesheet" type="text/css" href="../archivosbase/CSS/publicacionServicios.css">
	<link rel="stylesheet" type="text/css" href="../archivosbase/CSS/fotosseleccion.css">
	<link rel="stylesheet" type="text/css" href="../archivosbase/CSS/ajax-loader.css">
	<link rel="stylesheet" type="text/css" href="../archivosbase/CSS/mensaje_javascript.css">
    <link rel="shortcut icon" href="../archivosbase/icons/favicon.ico" />
	<script src="../archivosbase/jquerymobile145/jquery-3.2.1.min.js"></script>
 <script src="../archivosbase/jquerymobile145/jquery.mobile-1.4.5.min.js"></script>
 <script type="text/javascript" src="../cordova.js"></script>
   <script type="text/javascript"  src="../js/phonegap.js"></script>
   <script type="text/javascript" 
    src="https://maps.google.com/maps/api/js?sensor=false&key=AIzaSyDfGxUMXZLtPNZzXgJ1xioFvsJranjPkiU"> 
</script> 
	<script>
	var UID = localStorage.getItem('SesionID') || '<empty>';
	  var onSuccess = function(position) {
       /* alert('Latitude: '          + position.coords.latitude          + '\n' +
              'Longitude: '         + position.coords.longitude         + '\n');*/
    obtenerUbicacion(position.coords.latitude, position.coords.longitude,'inputLat','inputLon');
	};
 
    // onError Callback receives a PositionError object
    //
  var onError = function(error) {
        alert('code: '    + error.code    + '\n' +
              'message: ' + error.message + '\n');
    }

    
function cerrar(div){		
$("#" + div).fadeOut(150);
}
	function initialize() {
	
	$.get("../archivosbase/cabeza.html", function(htmlexterno){
   $("#cabecera").html(htmlexterno);
    	});
document.getElementById('inputUID').value=UID;
cordova.plugins.diagnostic.isLocationEnabled(function(enabled){
//alert(enabled);
var textobotones="";
if(enabled==true){
			textobotones=textobotones + "<input type='submit' onclick='gps();' value='Obtener ubicacion por GPS' />";
		textobotones=textobotones + "<input type='submit' onclick=\"obtenerUbicacion(-0.1574824, -78.4682946,'inputLat','inputLon');\" value='Ubicacion Predeterminada' />";
			}else{
		textobotones=textobotones + "<input type='submit' onclick=\"obtenerUbicacion(-0.1574824, -78.4682946,'inputLat','inputLon');\" value='Ubicacion Predeterminada' />";
			}
	document.getElementById('Botones').innerHTML=textobotones;	
}, function(error){alert(error);});
	ObtenerSucursales();
	}
	function ObtenerSucursales(){
	
	document.getElementById('ajax-loader').style.display='block';
	setTimeout(function(){	   
	   $.getJSON('https://nirjob.com/PhoneGap/ubicacion/locales.php?ID=' + UID, function(data) {  
		var tamanio=data.length;
		for(var i=0; i<tamanio; i++){
		if(data[i].ERROR=='0'){
		latitud=parseFloat(data[i].latitud);
		longitud=parseFloat(data[i].longitud);
		direccion=data[i].direccion;
		UbiId=data[i].UbiId;
			document.getElementById('inputLat').value=latitud;
			document.getElementById('inputLon').value=longitud;
			document.getElementById('direccion').value=direccion;
			obtenerUbicacion(latitud, longitud,'inputLat','inputLon');
		}
		if(data[0].ERROR=='1'){
		alert('ERROR: 404');
		}
		}
		document.getElementById('ajax-loader').style.display='none';	
		});	
	
		}, 150);
	}
function gps(){
navigator.geolocation.getCurrentPosition(onSuccess, onError);
}
	function getCoords(marker, inoutLat, inputLon)
					{ 
				document.getElementById(inoutLat).value=marker.getPosition().lat(); 
				document.getElementById(inputLon).value=marker.getPosition().lng(); 
					} 
				var contadorubicaciones=1;
				function obtenerUbicacion(lat,lon, inoutLat, inputLon) {	
				var myLatlng = new google.maps.LatLng(lat,lon); 
				document.getElementById('mapa').style.display='block';
				var myOptions = { 
				zoom: 16, 
        center: myLatlng, 
        mapTypeId: google.maps.MapTypeId.ROADMAP, 
    } 
    var map = new google.maps.Map(document.getElementById('mapaC'), myOptions); 
   marker = new google.maps.Marker({ 
          position: myLatlng, 
          draggable: true, 
          title:'Donde?' 
    });
	
    google.maps.event.addListener(marker, 'dragend', function() { 
                    getCoords(marker, inoutLat, inputLon); 
    }); 
     
      marker.setMap(map); 
    getCoords(marker, inoutLat, inputLon); 
  } 
  $(function(){
        $("#formUbicacion").on("submit", function(e){
            e.preventDefault();
            var f = $(this);
            var formData = new FormData(document.getElementById("formUbicacion"));
			document.getElementById('ajax-loader').style.display='block';
			setTimeout(function(){
            $.ajax({
                url: "https://nirjob.com/PhoneGap/ubicacion/SubirP.php",
                type: "post",
                dataType: "json",
                data: formData,
                cache: false,
                contentType: false,
	     processData: false
            }).done(function(data){
				var tamanio=data.length;
			
				if(data[0].Error=='0' && tamanio==1){
				
				var mensaje=document.getElementById('mensaje_javascript');
		mensaje.style.display='block';
var texto="<p>Exito al subir su Ubicaci&oacute;n.</p>";
texto= texto + "<button type='button' onclick='location.href=\"../index.html\";'>Aceptar</button>";
		mensaje.childNodes[0].innerHTML=texto;
			}else{
			var mensaje=document.getElementById('mensaje_javascript');
		mensaje.style.display='block';
var texto="<p>Error al subir su Ubicaci&oacute;n.</p>";
texto= texto + "<button type='button' onclick='cerrar(\"mensaje_javascript\")'>Regresar</button>";
		mensaje.childNodes[0].innerHTML=texto;
				}
			document.getElementById('ajax-loader').style.display='none';
                });
				
				}, 250);
        
		});
		});
	</script>
</head>
<body onload='initialize();'>
    <div id="container">
        <div id="cabecera">
        </div>
		<div id='contenido'>
		<div class='limpiador'></div>
		<div id='seleccionadorSubirDatos'>
		
		<div id='SubirDatosC' >
		<div id='Botones'>
		<!--<button type='button' onclick='gps();'>Obtener ubicacion por GPS</button>
		<button type='button' onclick="obtenerUbicacion(-0.1574824, -78.4682946,'inputLat','inputLon');">Ubicacion Predeterminada</button>
		<input type="submit" onclick='gps();' value='Obtener ubicacion por GPS' />
		<input type="submit" onclick="obtenerUbicacion(-0.1574824, -78.4682946,'inputLat','inputLon');" value='Ubicacion Predeterminada' />-->
		
		</div>
		<form id="formUbicacion" method="post" enctype="multipart/form-data">
		<div id='InputsC'>
		Direcci&oacute;n: <input type='text' id='direccion' name='direccion' value='NF' required />
		<input type='text' style='display:none' id='inputLat' name='latitud'	readonly value='' required />
		<input type='text' style='display:none' id='inputLon' name='longitud' readonly value='' required />
		</div>
		<div id='mapa' style='width:100%; height:20em; display:none;'>
		<div id='mapaC' style='width:90%; height:20em; margin-left:5%;'>
		</div>
		</div>
		<div>
		<input name='UID' value='' required readonly style='display:none' type='text' id='inputUID' />
		<input id='InputDescriEnviar' type='submit' value='Subir' />
		</div>
		</div>
		</form>
		

		</div>
		 </div>
		<div id='footer'>

		</div>
		<div id='ajax-loader'>
	<img src='../archivosbase/img/ajax-loader.gif'/>
	</div>
	<div id='mensaje_javascript'><div></div></div>
    </div>
</body>
</html>

